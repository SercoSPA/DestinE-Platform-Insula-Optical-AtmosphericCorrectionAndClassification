# Atmospheric Correction And Classification

This processor aims to perform [C2RCC](https://www.brockmann-consult.de/wp-content/uploads/2017/11/sco1_12brockmann.pdf) atmospheric correction on SENTINEL-3 OLCI level 1B images and pixel classification, using SNAP 10 graph.
In particular it focuses on processing OLCI Level-1B ERF images to Level-2 using the C2RCC atmospheric correction and complex water retrieval processor and implementing flagging with the IdePix multi-sensor pixel identification tool. As standard, OLCI level-2 marine products contain the geophysical parameters generated by the C2RCC processor (e.g. CHL_NN, TSM_NN), but they do not contain the reflectances ([SEN3-processing-levels-diagram](https://user.eumetsat.int/s3/eup-strapi-media/OLCI_all_products_2f364dde4c.png)). The [graph](sen3_c2rcc_snap_processor/GPT_config_template_subset_idepix_c2rcc.xml) will generate these reflectances, allowing different retrieval algorithms to be applied in complex waters, and flag the output appropriately using the quality flags provided by both the C2RCC processor and IdePix.
In addition, with a second [SNAP graph](sen3_c2rcc_snap_processor/GPT_config_template_subset_flag_reproject_chl.xml), the netCDF file is converted to a geo-referenced single band (chlorophyll percentage) Geotiff in order to be visible on general visualization tools, as DAMA on the platform.

## Structure
* Inputs:
    * a S3*.SEN3 OLCI Level-1B ERF not compressed file (it should be located [here](tmp/workDir/inDir/input/))
    * and an intersecting polygon AOI in shapely.geometry format ([here](tmp/FSTEP-WPS-INPUT.properties))
* Outputs:
    * a S3*_c2rcc.nc file, atmospherically corrected;
    * and S3*_CHL_NN.tif file, a Geotif (COG format) of chlorophyll percentage concentration

The platform directory structure, once ingesting inputs and aoi through the user interface, positionates all files as shown in the [tmp/](tmp/) directory.

## Usage
To run the following code:
```bash
cd sen3_c2rcc_snap_processor
# Create a Docker image based on the instructions specified in the Dockerfile located in the current directory and call it <container-name>
docker build . -t <container-name>
# Run the Docker image as a container, mounting /tmp/workDir/ directory into the container at the /home/worker/workDir path
docker run -v <absolute_path_to>/tmp/workDir/:/home/worker/workDir <container-name>
```

Note: Ensure that the [input](tmp/workDir/inDir/input/) contains an uncompressed folder of the Sentinel3 product, for example:
 
```bash
./tmp/workDir/inDir/input/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002.SEN3
```

## Logs
The message received once launch the processor is somethig similar to the following:

```
...
Processing Sentinel3 file:
atmospheric correction,
scene classification
and generation of some phisical paramethers i.e. chlorophyll content
+ echo -e 'Processing Sentinel3 file: \natmospheric correction, \nscene classification \nand generation of some phisical paramethers i.e. chlorophyll content'
+ /usr/local/snap/bin/gpt /home/worker/procDir/GPT_config_template_subset_idepix_c2rcc.xml -Pinput_img=/home/worker/workDir/inDir/input/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002.SEN3/xfdumanifest.xml '-Pgeo_region=POLYGON ((37.5 65.75, 42.5 65.75, 44.5 68.25, 38.5 68.25, 37.5 65.75))' -Poutput_product=/home/worker/procDir/tmp/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_c2rcc.nc
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.esa.snap.runtime.Engine (file:/usr/local/snap/snap/modules/ext/org.esa.snap.snap-core/org-esa-snap/snap-runtime.jar) to method java.lang.ClassLoader.initializePath(java.lang.String)
WARNING: Please consider reporting this to the maintainers of org.esa.snap.runtime.Engine
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
WARNING: org.esa.snap.core.util.ServiceLoader: org.esa.snap.core.gpf.OperatorSpi: Provider eu.esa.opt.meris.sdr.aerosol.AerosolMergerOp$Spi not found
WARNING: org.esa.snap.core.util.ServiceLoader: org.esa.snap.core.gpf.OperatorSpi: Provider eu.esa.opt.meris.sdr.aerosol.ModisAerosolOp$Spi not found
INFO: org.esa.snap.core.gpf.operators.tooladapter.ToolAdapterIO: Initializing external tool adapters
INFO: org.esa.snap.core.util.EngineVersionCheckActivator: Please check regularly for new updates for the best SNAP experience.
Executing processing graph
INFO: eu.esa.opt.c2rcc.olci.C2rccOlciOperator: c2rcc initial tile : null, configured tile: java.awt.Dimension[width=1217,height=1023]

100% done.
2024-09-11 14:21:56.247420: I tensorflow/cc/saved_model/reader.cc:31] Reading SavedModel from: /root/.snap/auxdata/idepix_olci/nn_ctp/nn_training_20190131_I7x30x30x30x10x2xO1
2024-09-11 14:21:56.248290: I tensorflow/cc/saved_model/reader.cc:54] Reading meta graph with tags { serve }
2024-09-11 14:21:56.248949: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 AVX512F FMA
2024-09-11 14:21:56.266101: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 2294605000 Hz
2024-09-11 14:21:56.267642: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x709e0c35b160 initialized for platform Host (this does not guarantee that XLA will be used). Devices:
2024-09-11 14:21:56.267703: I tensorflow/compiler/xla/service/service.cc:176]   StreamExecutor device (0): Host, Default Version
2024-09-11 14:21:56.275369: I tensorflow/cc/saved_model/loader.cc:202] Restoring SavedModel bundle.
2024-09-11 14:21:56.301108: I tensorflow/cc/saved_model/loader.cc:311] SavedModel load for tags { serve }; Status: success. Took 53700 microseconds.
Executing CTP processing...
WARNING: org.esa.snap.dataio.netcdf.util.MetadataUtils: Missing configuration property 'snap.dataio.netcdf.metadataElementLimit'. Using default (100).
Initializing Desmile Auxiliary Data
12%25%37%50%62%75%87%100% done.
 done.
WARNING: org.esa.snap.dataio.netcdf.util.MetadataUtils: Missing configuration property 'snap.dataio.netcdf.metadataElementLimit'. Using default (100).

100% done.

100% done.

100% done.

100% done.
11%22%.33%45%56%....66%17854 [main] INFO serverStartup - Nc4Iosp: NetCDF-4 C library loaded (jna_path='/root/.snap/auxdata/netcdf_natives/10.0.0/amd64', libname='netcdf').
17862 [main] INFO serverStartup - NetcdfLoader: set log level: old=0 new=0
17862 [main] INFO serverStartup - Nc4Iosp: set log level: old=0 new=0
78%89%
100% done.
 done.
Extracting chlorophyll percentage concentration
and converting netcdf file to geotiff
+ echo -e 'Extracting chlorophyll percentage concentration \nand converting netcdf file to geotiff'
+ /usr/local/snap/bin/gpt /home/worker/procDir/GPT_config_template_subset_flag_reproject_chl.xml -Pinput_img=/home/worker/procDir/tmp/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_c2rcc.nc '-Pgeo_region=POLYGON ((37.5 65.75, 42.5 65.75, 44.5 68.25, 38.5 68.25, 37.5 65.75))' -Poutput_product=/home/worker/procDir/tmp/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_CHL_NN.tif
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.esa.snap.runtime.Engine (file:/usr/local/snap/snap/modules/ext/org.esa.snap.snap-core/org-esa-snap/snap-runtime.jar) to method java.lang.ClassLoader.initializePath(java.lang.String)
WARNING: Please consider reporting this to the maintainers of org.esa.snap.runtime.Engine
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
WARNING: org.esa.snap.core.util.ServiceLoader: org.esa.snap.core.gpf.OperatorSpi: Provider eu.esa.opt.meris.sdr.aerosol.AerosolMergerOp$Spi not found
WARNING: org.esa.snap.core.util.ServiceLoader: org.esa.snap.core.gpf.OperatorSpi: Provider eu.esa.opt.meris.sdr.aerosol.ModisAerosolOp$Spi not found
INFO: org.esa.snap.core.gpf.operators.tooladapter.ToolAdapterIO: Initializing external tool adapters
INFO: org.esa.snap.core.util.EngineVersionCheckActivator: Please check regularly for new updates for the best SNAP experience.
Executing processing graph
WARNING: org.esa.snap.dataio.netcdf.util.MetadataUtils: Missing configuration property 'snap.dataio.netcdf.metadataElementLimit'. Using default (100).
10%20%30%40%....50%60%70%80%90% done.
+ path_code=/home/worker/procDir/extract_tif.py
+ /home/worker/procDir/venv/bin/python3 /home/worker/procDir/extract_tif.py -input_path /home/worker/procDir/tmp -output_path /home/worker/workDir/outDir/output
/home/worker/workDir/outDir/output/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_CHL_NN.tif
2024-09-11T14:25:27 INFO     cog of S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_CHL_NN.tif already present.
+ '[' 0 -ne 0 ']'
+ cp /home/worker/procDir/tmp/S3B_OL_1_EFR____20220628T081655_20220628T081955_20220628T101934_0180_067_292_1800_PS2_O_NR_002_c2rcc.nc /home/worker/workDir/outDir/output/

```
